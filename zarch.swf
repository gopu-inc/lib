#!/usr/bin/env swift
// ============================================================
//  ZARCH v2.0 (OOP Edition)
// ============================================================

import "http"; import "sys"; import "io"; import "json"; import "std";

// --- ENUMS ---
enum Color { 
    RESET, CYAN, GREEN, YELLOW, RED, BOLD 
}

enum Status {
    SUCCESS, ERROR, WARNING
}

// --- CLASSE LOGGER ---
class Logger {
    func info(msg) {
        print("\033[36m[INFO] \033[0m", msg);
    }
    func success(msg) {
        print("\033[32m[OK]   \033[0m", msg);
    }
    func error(msg) {
        print("\033[31m[FAIL] \033[0m", msg);
        sys.exit(1);
    }
}

// --- CLASSE PACKAGE MANAGER ---
class Zarch {
    var registry = "https://zenv-hub.onrender.com";
    var modules_dir = "./zarch_modules";
    var log = new Logger();

    func install(pkg_name) {
        // V√©rif dossier
        if (io.exists(this.modules_dir) == 0) {
            io.mkdir(this.modules_dir);
        }

        print("üì¶ Package : ", pkg_name);

        // API Call
        var url = this.registry + "/api/package/info/global/" + pkg_name;
        var json_resp = http.get(url);

        if (json_resp == null) { 
            this.log.error("Package introuvable."); 
            return;
        }

        var dl_path = json.get(json_resp, "download_url");
        var version = json.get(json_resp, "latest_version");

        if (dl_path == null) { this.log.error("URL invalide."); return; }

        this.log.info("Version trouv√©e : " + version);

        // Download
        var full_url = this.registry + dl_path;
        var target_file = this.modules_dir + "/" + pkg_name + ".tar.gz";
        var target_dir = this.modules_dir + "/" + pkg_name;

        var res = http.download(full_url, target_file);

        if (res == "success") {
            if (io.exists(target_dir) == 0) io.mkdir(target_dir);
            
            var cmd = "tar -xzf " + target_file + " -C " + target_dir;
            sys.exec(cmd);
            sys.exec("rm " + target_file);
            
            this.link_alias(target_dir, pkg_name);
            this.log.success("Install√© : " + pkg_name);
        } else {
            this.log.error("Erreur t√©l√©chargement.");
        }
    }

    func link_alias(dir, pkg_name) {
        var mf = dir + "/zarch.json";
        if (io.exists(mf) == 1) {
            var c = io.read(mf);
            var main = json.get(c, "main");
            if (main != null) {
                var src = dir + "/" + main;
                var lnk = pkg_name + ".swf";
                sys.exec("ln -sf " + src + " " + lnk);
            }
        }
    }
}

// --- MAIN ---
main() {
    // Instanciation de la classe
    var app = new Zarch();
    var cmd = sys.argv(0);

    if (cmd == "install") {
        var pkg = sys.argv(1);
        if (pkg != null) {
            app.install(pkg);
        } else {
            print("Erreur: Nom du paquet manquant");
        }
    }
    elif (cmd == "help") {
        print("Usage: zarch install <pkg>");
    }
    else {
        print("Commande inconnue (essayez 'install' ou 'help')");
    }
}
